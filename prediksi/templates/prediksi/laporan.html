{% extends "base.html" %}

{% block title %}Laporan Historis - SmartSense{% endblock %}

{% block content %}
{# Ini adalah container utama yang memberikan efek 'kotak' seperti di dashboard #}
<div class="container" style="max-width: 900px; margin: auto; background: var(--card-bg); padding: 40px; border-radius: var(--border-radius); box-shadow: 0 8px 30px rgba(0,0,0,0.08); border-top: 5px solid var(--primary-color);">

    <div class="d-flex justify-content-between align-items-center mb-4 text-start">
        <div>
            <h1 class="h2 fw-bold text-dark">Laporan Data Historis</h1>
            <p class="text-muted mb-0">Analisis data sensor selama {{ days_filtered }} hari terakhir.</p>
        </div>
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                Pilih Periode
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="?days=1">24 Jam Terakhir</a></li>
                <li><a class="dropdown-item" href="?days=7">7 Hari Terakhir</a></li>
                <li><a class="dropdown-item" href="?days=30">30 Hari Terakhir</a></li>
            </ul>
        </div>
    </div>

    <hr class="my-4">

    <div class="row text-start">
        <div class="col-lg-6 mb-4">
            <h5 class="card-title text-muted mb-3">Statistik Suhu (℃)</h5>
            <div class="card border-0" style="background-color: #f8f9fa;">
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 bg-transparent">Rata-rata: <span class="badge bg-primary rounded-pill fs-6">{{ stats.avg_suhu|floatformat:2 }}</span></li>
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 bg-transparent">Maksimum: <span class="badge bg-danger rounded-pill fs-6">{{ stats.max_suhu|floatformat:2 }}</span></li>
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 bg-transparent">Minimum: <span class="badge bg-info rounded-pill fs-6">{{ stats.min_suhu|floatformat:2 }}</span></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <h5 class="card-title text-muted mb-3">Statistik Kelembapan (%)</h5>
            <div class="card border-0" style="background-color: #f8f9fa;">
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 bg-transparent">Rata-rata: <span class="badge bg-primary rounded-pill fs-6">{{ stats.avg_kelembapan|floatformat:2 }}</span></li>
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 bg-transparent">Maksimum: <span class="badge bg-danger rounded-pill fs-6">{{ stats.max_kelembapan|floatformat:2 }}</span></li>
                        <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 bg-transparent">Minimum: <span class="badge bg-info rounded-pill fs-6">{{ stats.min_kelembapan|floatformat:2 }}</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <h5 class="card-title text-center text-muted mb-3">Grafik Tren Data</h5>
        <canvas id="historyChart"></canvas>
    </div>

    <div class="mt-5">
        <h5 class="card-title text-start text-muted mb-3">Detail Log Data</h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0" style="border-radius: var(--border-radius); overflow: hidden;">
                <thead class="table-light">
                    <tr>
                        <th scope="col" class="ps-3">Waktu</th>
                        <th scope="col">Suhu (℃)</th>
                        <th scope="col">Kelembapan (%)</th>
                    </tr>
                </thead>
                    <tbody>
                        {% for data in page_obj %}
                        <tr>
                            <td class="ps-3">{{ data._time|date:"d M Y, H:i" }}</td>
                            <td>{{ data.temperature|floatformat:2 }}</td>
                            <td>{{ data.humidity|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center py-4">Tidak ada data untuk ditampilkan dari InfluxDB.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
            </table>
        </div>
        {% if page_obj.paginator.num_pages > 1 %}
        <div class="mt-3">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item"><a class="page-link" href="?days={{ days_filtered }}&page={{ page_obj.previous_page_number }}">Sebelumnya</a></li>
                    {% else %}
                        <li class="page-item disabled"><a class="page-link" href="#">Sebelumnya</a></li>
                    {% endif %}
                    
                    <li class="page-item active" aria-current="page"><span class="page-link">{{ page_obj.number }}</span></li>

                    {% if page_obj.has_next %}
                        <li class="page-item"><a class="page-link" href="?days={{ days_filtered }}&page={{ page_obj.next_page_number }}">Selanjutnya</a></li>
                    {% else %}
                         <li class="page-item disabled"><a class="page-link" href="#">Selanjutnya</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    const ctx = document.getElementById('historyChart');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [
                {
                    label: 'Suhu (°C)',
                    data: {{ chart_suhu_data|safe }},
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: 'Kelembapan (%)',
                    data: {{ chart_kelembapan_data|safe }},
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: { responsive: true }
    });
</script>
{% endblock %}